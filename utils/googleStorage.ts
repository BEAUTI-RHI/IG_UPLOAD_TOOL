// utils/googleStorage.ts
import { Storage, GetSignedUrlConfig } from "@google-cloud/storage";
import { setupGoogleCredentials } from "./setupGoogleCredentials";

setupGoogleCredentials();

const storage = new Storage();
const bucketName = process.env.BUCKET_NAME!;

export async function generateSignedUrl(filePath: string) {
  try {
    const options: GetSignedUrlConfig = {
      version: "v4",
      action: "write", // TypeScript now knows this must be 'write' | 'read' | 'delete' | 'resumable'
      expires: Date.now() + 15 * 60 * 1000, // 15 minutes
    };

    const response = await storage
      .bucket(bucketName)
      .file(filePath)
      .getSignedUrl(options);

    return response[0];
  } catch (error) {
    console.error("Error generating signed URL:", error);
    throw new Error("Failed to generate signed URL");
  }
}

export async function generateReadSignedUrl(filePath: string): Promise<string> {
  try {
    const options: GetSignedUrlConfig = {
      version: "v4",
      action: "read", // TypeScript now knows this must be 'write' | 'read' | 'delete' | 'resumable'
      expires: Date.now() + 15 * 60 * 1000, // 15 minutes
    };

    const response = await storage
      .bucket(bucketName)
      .file(filePath)
      .getSignedUrl(options);

    return response[0];
  } catch (error) {
    console.error("Error generating read signed URL:", error);
    throw new Error("Failed to generate read signed URL");
  }
}

///////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////

interface SignedUrlResponse {
  uploadUrl: string;
  publicUrl: string;
  filePath: string;
}

export async function generateUploadSignedUrls(
  fileName: string
): Promise<SignedUrlResponse> {
  try {
    const timestamp = Date.now();
    const safeFileName = fileName.replace(/[^a-zA-Z0-9.-]/g, "_");
    const filePath = `reels/${timestamp}-${safeFileName}`;

    // Generate upload URL
    const uploadOptions: GetSignedUrlConfig = {
      version: "v4",
      action: "write",
      expires: Date.now() + 15 * 60 * 1000, // 15 minutes
      contentType: "video/mp4",
    };

    const [uploadUrl] = await storage
      .bucket(bucketName)
      .file(filePath)
      .getSignedUrl(uploadOptions);

    // Generate read URL
    const readOptions: GetSignedUrlConfig = {
      version: "v4",
      action: "read",
      expires: Date.now() + 24 * 60 * 60 * 1000, // 24 hours
    };

    const [publicUrl] = await storage
      .bucket(bucketName)
      .file(filePath)
      .getSignedUrl(readOptions);

    return { uploadUrl, publicUrl, filePath };
  } catch (error) {
    console.error("Error generating signed URLs:", error);
    throw new Error("Failed to generate signed URLs");
  }
}
